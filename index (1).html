<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Medical - Monitor Pacienți</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c5282 0%, #2d3748 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .config-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .auth-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto 30px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c5282;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2c5282;
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #2c5282 0%, #2d3748 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(44, 82, 130, 0.3);
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .doctor-info {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .doctor-details h3 {
            color: #2c5282;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .logout-btn {
            background: #e53e3e;
            padding: 10px 20px;
            font-size: 14px;
            width: auto;
        }

        .patients-list {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .patients-list h3 {
            color: #2c5282;
            margin-bottom: 25px;
            font-size: 1.5em;
            text-align: center;
        }

        .patient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .patient-item:hover {
            border-color: #2c5282;
            background: #f0f4f8;
            transform: translateY(-2px);
        }

        .patient-item.selected {
            border-color: #2c5282;
            background: #e6f3ff;
        }

        .patient-info {
            flex-grow: 1;
        }

        .patient-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .patient-details {
            color: #666;
            font-size: 0.95em;
        }

        .patient-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .alert-normal {
            background: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.2);
        }

        .alert-warning {
            background: #ed8936;
            box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.2);
            animation: pulse-warning 2s infinite;
        }

        .alert-critical {
            background: #e53e3e;
            box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.3);
            animation: pulse-critical 1s infinite;
        }

        .alert-offline {
            background: #a0aec0;
            box-shadow: 0 0 0 3px rgba(160, 174, 192, 0.2);
        }

        @keyframes pulse-warning {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.2);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 6px rgba(237, 137, 54, 0.4);
            }
        }

        @keyframes pulse-critical {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.3);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 0 8px rgba(229, 62, 62, 0.6);
            }
        }

        .patient-values {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: none;
        }

        .patient-values.active {
            display: block;
        }

        .patient-values h4 {
            color: #2c5282;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }

        .values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .value-item {
            text-align: center;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .ecg-item {
            grid-column: span 2; /* ECG ocupă 2 coloane */
            text-align: left;
        }

        .ecg-container {
            background: #000;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            position: relative;
        }

        #ecg-canvas {
            width: 100%;
            height: 120px;
            display: block;
        }

        .ecg-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .ecg-bpm {
            font-weight: bold;
            font-size: 16px;
        }

        .ecg-rhythm {
            font-style: italic;
        }

        .value-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .value-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #2d3748;
        }

        .value-status {
            font-size: 0.8em;
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 12px;
        }

        .status-normal { background: #c6f6d5; color: #22543d; }
        .status-warning { background: #feebc8; color: #c05621; }
        .status-critical { background: #fed7d7; color: #c53030; }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #fc8181;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #9ae6b4;
        }

        .info {
            background: #bee3f8;
            color: #2c5282;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #63b3ed;
        }

        .last-update {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 1.1em;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-disconnected {
            background: #fed7d7;
            color: #c53030;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">🔌 Verificare conexiune...</div>

    <div class="container">
        <div class="header">
            <h1>⚕️ Portal Medical</h1>
            <p>Monitor pacienți în timp real</p>
        </div>

        <!-- Configurare API -->
        <div id="config-section" class="config-section">
            <h3>⚙️ Conexiune la API-ul colegului</h3>
            <p style="margin-bottom: 15px; color: #856404;">
                <strong>✅ API-ul colegului (HTTPS ngrok):</strong> <code>https://6181-74-234-34-29.ngrok-free.app</code><br>
                Endpoint-uri disponibile: <code>/login</code>, <code>/profile</code>, <code>/pacienti</code>
            </p>
            <input type="text" id="api-url" class="config-input" 
                   placeholder="URL API actualizat de coleg"
                   value="https://6181-74-234-34-29.ngrok-free.app">
            <button class="btn btn-small" onclick="saveApiConfig()">Testează conexiunea</button>
        </div>

        <!-- Mesaje -->
        <div id="messages"></div>

        <!-- Secțiunea de autentificare pentru medici -->
        <div id="auth-section" class="auth-section">
            <div class="login-form">
                <h2>🩺 Autentificare Medic</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="login-email">Username:</label>
                        <input type="text" id="login-email" placeholder="Username medic" 
                               value="doctor1" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Parolă:</label>
                        <input type="password" id="login-password" placeholder="Parola ta" 
                               value="Test1234!" required>
                    </div>
                    <button type="submit" class="btn">Acces Portal Medical</button>
                    
                    <!-- Buton pentru demonstrație -->
                    <button type="button" class="btn" onclick="demoMode()" 
                            style="background: #38a169; margin-top: 10px;">
                        🎬 DEMO - Vezi aplicația fără login
                    </button>
                </form>
            </div>
        </div>

        <!-- Dashboard-ul pentru medici -->
        <div id="dashboard" class="dashboard">
            <!-- Informații medic -->
            <div class="doctor-info">
                <div class="doctor-details">
                    <h3>Dr. <span id="doctor-name">Nume Doctor</span></h3>
                    <p><strong>Email:</strong> <span id="doctor-email">doctor@spital.ro</span></p>
                </div>
                <button class="btn logout-btn" onclick="logout()">Deconectare</button>
            </div>

            <!-- Lista pacienților -->
            <div class="patients-list">
                <h3>📋 Lista Pacienți</h3>
                
                <!-- Legenda pentru bulinuțe -->
                <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 0.9em;">
                    <strong>🔍 Legenda alertelor:</strong><br>
                    <span style="display: inline-flex; align-items: center; margin-right: 15px;">
                        <div style="width: 12px; height: 12px; background: #48bb78; border-radius: 50%; margin-right: 5px;"></div>
                        <span>Toate parametrii normali</span>
                    </span>
                    <span style="display: inline-flex; align-items: center; margin-right: 15px;">
                        <div style="width: 12px; height: 12px; background: #ed8936; border-radius: 50%; margin-right: 5px;"></div>
                        <span>Cel puțin un parametru la limită</span>
                    </span>
                    <span style="display: inline-flex; align-items: center;">
                        <div style="width: 12px; height: 12px; background: #e53e3e; border-radius: 50%; margin-right: 5px;"></div>
                        <span>Cel puțin un parametru critic</span>
                    </span>
                </div>
                
                <div id="patients-container">
                    <div class="info">
                        📡 Se încearcă conectarea la API pentru încărcarea pacienților...
                    </div>
                </div>
            </div>

            <!-- Detalii pacient selectat -->
            <div id="patient-values" class="patient-values">
                <h4>Măsurători pentru: <span id="selected-patient-name">-</span></h4>
                <div class="values-grid">
                    <div class="value-item">
                        <div class="value-label">Temperatură</div>
                        <div class="value-number" id="temp-value">--°C</div>
                        <div class="value-status status-normal" id="temp-status">-</div>
                    </div>
                    <div class="value-item">
                        <div class="value-label">Puls</div>
                        <div class="value-number" id="pulse-value">-- BPM</div>
                        <div class="value-status status-normal" id="pulse-status">-</div>
                    </div>
                    <div class="value-item">
                        <div class="value-label">Umiditate</div>
                        <div class="value-number" id="humidity-value">--%</div>
                        <div class="value-status status-normal" id="humidity-status">-</div>
                    </div>
                    <div class="value-item ecg-item">
                        <div class="value-label">Electrocardiogramă (ECG)</div>
                        <div class="ecg-container">
                            <canvas id="ecg-canvas" width="300" height="120"></canvas>
                            <div class="ecg-info">
                                <span class="ecg-bpm" id="ecg-bpm">75 BPM</span>
                                <span class="ecg-rhythm" id="ecg-rhythm">Ritm sinusal normal</span>
                            </div>
                        </div>
                        <div class="value-status status-normal" id="ecg-status">Normal</div>
                    </div>
                </div>
            </div>

            <div class="last-update">
                Ultima actualizare: <span id="last-update">-</span>
            </div>
        </div>
    </div>

    <script>
        // 📁 API Functions - adaptat cu autentificare JWT
        const BASE_URL = "https://6181-74-234-34-29.ngrok-free.app";

        // 🔐 Login utilizator în MySQL
        async function apiLogin(username, password) {
            const res = await fetch(`${BASE_URL}/mysql-login`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "true"
                },
                body: JSON.stringify({ username, password }),
            });
            return res.json();
        }

        // 📋 Lista pacienților medicului (cu autentificare)
        async function getPacienti(idMedic) {
            const res = await fetch(`${BASE_URL}/medic/${idMedic}/pacienti`, {
                headers: {
                    "Authorization": `Bearer ${authToken}`,
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "true"
                }
            });
            return res.json();
        }

        // 📊 Măsurători recente pentru un pacient (cu autentificare)
        async function getMasuratori(idPacient) {
            const res = await fetch(`${BASE_URL}/pacient/${idPacient}/masuratori`, {
                headers: {
                    "Authorization": `Bearer ${authToken}`,
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "true"
                }
            });
            return res.json();
        }

        // 🚨 Alerte pentru pacient (cu autentificare)
        async function getAlerte(idPacient) {
            const res = await fetch(`${BASE_URL}/pacient/${idPacient}/alerte`, {
                headers: {
                    "Authorization": `Bearer ${authToken}`,
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "true"
                }
            });
            return res.json();
        }

        // 💬 Recomandări existente (cu autentificare)
        async function getRecomandari(idPacient) {
            const res = await fetch(`${BASE_URL}/pacient/${idPacient}/recomandari`, {
                headers: {
                    "Authorization": `Bearer ${authToken}`,
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "true"
                }
            });
            return res.json();
        }

        // ➕ Trimite o recomandare nouă (cu autentificare)
        async function trimiteRecomandare(idPacient, text) {
            const res = await fetch(`${BASE_URL}/pacient/${idPacient}/recomandari`, {
                method: "POST",
                headers: { 
                    "Authorization": `Bearer ${authToken}`,
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "true"
                },
                body: JSON.stringify({ text }),
            });
            return res.json();
        }

        // Variabile pentru ECG în timp real
        let ecgCanvas = null;
        let ecgCtx = null;
        let ecgDataBuffer = []; // Buffer pentru punctele ECG primite
        let ecgAnimation = null;
        let ecgTime = 0;
        let maxECGBufferSize = 500; // Păstrăm ultimele 500 de puncte (5 secunde la 100Hz)
        let ecgSampleRate = 100; // Hz - câte puncte pe secundă primim de la Arduino
        let isReceivingRealECG = false; // Flag pentru date reale vs simulate

        // Inițializare când se încarcă aplicația
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('api-url').value = API_BASE_URL;
            testApiConnection();
            
            if (authToken) {
                showDashboard();
            }
        });

        // Salvare configurare API
        function saveApiConfig() {
            const apiUrl = document.getElementById('api-url').value.trim();
            if (!apiUrl) {
                showMessage('Te rog introdu URL-ul API-ului!', 'error');
                return;
            }
            
            // Elimină slash-ul final dacă există
            API_BASE_URL = apiUrl.replace(/\/$/, '');
            localStorage.setItem('api_base_url', API_BASE_URL);
            
            showMessage('Configurare salvată! Se testează conexiunea...', 'info');
            testApiConnection();
        }

        // Test conexiune API (adaptat pentru endpoint-urile colegului)
        async function testApiConnection() {
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = '🔄 Testare conexiune...';
            statusElement.className = 'connection-status';
            
            try {
                // Testează direct endpoint-ul /login pentru a vedea dacă API-ul răspunde
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: 'test', password: 'test' }),
                    signal: AbortSignal.timeout(5000) // timeout 5 secunde
                });
                
                // Dacă primim răspuns (chiar dacă e eroare de autentificare), API-ul funcționează
                if (response.status === 400 || response.status === 401 || response.ok) {
                    isApiConnected = true;
                    statusElement.textContent = '✅ API conectat';
                    statusElement.className = 'connection-status status-connected';
                    document.getElementById('config-section').style.display = 'none';
                    showMessage('API conectat cu succes! Poți să te autentifici.', 'success');
                } else {
                    throw new Error('API nu răspunde corect');
                }
            } catch (error) {
                isApiConnected = false;
                statusElement.textContent = '❌ API deconectat';
                statusElement.className = 'connection-status status-disconnected';
                document.getElementById('config-section').style.display = 'block';
                
                console.error('Eroare conexiune API:', error);
                showMessage(`Nu se poate conecta la API: ${API_BASE_URL}. Verifică dacă serverul colegului rulează.`, 'error');
            }
        }

        // Funcție pentru afișarea mesajelor
        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // Gestionare login cu fallback inteligent
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                showMessage('Se încearcă conectarea...', 'info');
                
                // Încearcă primul API-ul colegului (/mysql-login)
                try {
                    console.log('Încercare login cu /mysql-login...');
                    const response = await fetch(`${API_BASE_URL}/mysql-login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        },
                        body: JSON.stringify({ username, password })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Login reușit cu /mysql-login:', data);
                        
                        if (data.token) {
                            authToken = data.token;
                            currentDoctor = {
                                id: data.user?.id || data.user?._id || 1,
                                nume: `Dr. ${data.user?.username || username}`,
                                email: data.user?.email || `${username}@spital.ro`,
                                username: data.user?.username || username
                            };
                            
                            localStorage.setItem('authToken', authToken);
                            localStorage.setItem('currentDoctor', JSON.stringify(currentDoctor));
                            
                            showMessage('Autentificare reușită cu API-ul colegului!', 'success');
                            showDashboard();
                            return; // Exit function on success
                        }
                    } else if (response.status === 404) {
                        console.log('/mysql-login nu există (404), încercând fallback...');
                        throw new Error('Endpoint nu există');
                    } else {
                        const errorData = await response.json().catch(() => ({ message: 'Eroare necunoscută' }));
                        throw new Error(`API error: ${errorData.message}`);
                    }
                } catch (apiError) {
                    console.log('API coleg nu funcționează, fallback la /login:', apiError.message);
                    
                    // Fallback la sistemul anterior (/login)
                    try {
                        console.log('Încercare login cu /login (fallback)...');
                        const response = await fetch(`${API_BASE_URL}/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'ngrok-skip-browser-warning': 'true'
                            },
                            body: JSON.stringify({ username, password })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            console.log('Login reușit cu fallback /login:', data);
                            
                            if (data.token) {
                                authToken = data.token;
                                
                                // Obține profilul utilizatorului
                                await getUserProfile();
                                
                                localStorage.setItem('authToken', authToken);
                                localStorage.setItem('currentDoctor', JSON.stringify(currentDoctor));
                                
                                showMessage('Autentificare reușită cu fallback!', 'success');
                                showDashboard();
                                return; // Exit function on success
                            }
                        } else {
                            throw new Error(`Fallback login failed: ${response.status}`);
                        }
                    } catch (fallbackError) {
                        console.error('Fallback login failed:', fallbackError);
                        throw new Error('Ambele sisteme de login au eșuat');
                    }
                }
            } catch (error) {
                console.error('Eroare completă login:', error);
                showMessage(`Eroare de conectare: ${error.message}. Folosește butonul DEMO pentru prezentare.`, 'error');
            }
        }

        // Obține profilul utilizatorului după login (adaptat pentru ngrok)
        async function getUserProfile() {
            try {
                const response = await fetch(`${API_BASE_URL}/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'  // Skip ngrok warning page
                    }
                });

                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const profileData = await response.json();
                        console.log('Profile data:', profileData);
                        
                        currentDoctor = {
                            id: profileData._id || profileData.id || 1,
                            nume: `Dr. ${profileData.username}` || 'Dr. Medical',
                            email: profileData.email || `${profileData.username}@spital.ro`,
                            username: profileData.username
                        };
                    } else {
                        throw new Error('Profile endpoint returnează HTML în loc de JSON');
                    }
                } else {
                    throw new Error(`Profile endpoint răspunde cu status ${response.status}`);
                }
            } catch (error) {
                console.log('Profile endpoint nu funcționează, folosesc date de bază:', error.message);
                currentDoctor = {
                    id: 1,
                    nume: `Dr. ${document.getElementById('login-email').value}`,
                    email: `${document.getElementById('login-email').value}@spital.ro`,
                    username: document.getElementById('login-email').value
                };
            }
        }

        // Afișare dashboard pentru medici
        async function showDashboard() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('config-section').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            
            // Actualizează informațiile medicului
            document.getElementById('doctor-name').textContent = currentDoctor.nume || currentDoctor.username || 'Doctor';
            document.getElementById('doctor-email').textContent = currentDoctor.email || 'doctor@spital.ro';
            
            // Încarcă lista pacienților
            await loadPatients();
            
            // Inițializează ECG canvas
            initializeECG();
            
            // Pornește actualizarea automată
            startMonitoring();
        }

        // Inițializare grafic ECG
        function initializeECG() {
            ecgCanvas = document.getElementById('ecg-canvas');
            if (!ecgCanvas) return;
            
            ecgCtx = ecgCanvas.getContext('2d');
            
            // Setează dimensiunile canvas-ului
            const rect = ecgCanvas.getBoundingClientRect();
            ecgCanvas.width = rect.width * 2; // Pentru claritate pe ecrane HD
            ecgCanvas.height = rect.height * 2;
            ecgCtx.scale(2, 2);
            
            // Pornește animația ECG
            startECGAnimation();
        }

        // Procesare date ECG în timp real de la cloud
        function processRealTimeECG(ecgDataFromCloud) {
            try {
                // Verifică tipul datelor primite
                if (Array.isArray(ecgDataFromCloud)) {
                    // Cazul 1: Array cu puncte ECG raw de la Arduino
                    addECGPointsToBuffer(ecgDataFromCloud);
                } else if (ecgDataFromCloud.rawData) {
                    // Cazul 2: Obiect cu date procesate + puncte raw
                    addECGPointsToBuffer(ecgDataFromCloud.rawData);
                    updateECGMetrics(ecgDataFromCloud);
                } else if (typeof ecgDataFromCloud === 'number') {
                    // Cazul 3: Un singur punct ECG
                    addECGPointsToBuffer([ecgDataFromCloud]);
                }
                
                isReceivingRealECG = true;
                console.log(`ECG buffer size: ${ecgDataBuffer.length} puncte`);
            } catch (error) {
                console.error('Eroare procesare ECG real:', error);
                isReceivingRealECG = false;
            }
        }

        // Adaugă puncte ECG în buffer
        function addECGPointsToBuffer(newPoints) {
            // Adaugă punctele noi la sfârșitul buffer-ului
            ecgDataBuffer.push(...newPoints);
            
            // Păstrează doar ultimele puncte (sliding window)
            if (ecgDataBuffer.length > maxECGBufferSize) {
                ecgDataBuffer = ecgDataBuffer.slice(-maxECGBufferSize);
            }
        }

        // Actualizează metrici ECG (BPM, ritm)
        function updateECGMetrics(ecgData) {
            if (ecgData.heartRate) {
                document.getElementById('ecg-bpm').textContent = `${ecgData.heartRate} BPM`;
            }
            
            if (ecgData.rhythm) {
                const rhythmElement = document.getElementById('ecg-rhythm');
                rhythmElement.textContent = getECGRhythmText(ecgData.rhythm);
                rhythmElement.style.color = getECGRhythmColor(ecgData.rhythm);
            }
        }

        // Convertește codul ritmului în text
        function getECGRhythmText(rhythm) {
            const rhythms = {
                'normal': 'Ritm sinusal normal',
                'arrhythmia': 'Aritmie detectată',
                'tachycardia': 'Tahicardie',
                'bradycardia': 'Bradicardie',
                'irregular': 'Ritm neregulat',
                'atrial_fib': 'Fibrilație atrială'
            };
            return rhythms[rhythm] || 'Ritm necunoscut';
        }

        // Culoarea pentru tipul de ritm
        function getECGRhythmColor(rhythm) {
            const colors = {
                'normal': '#00ff00',
                'arrhythmia': '#ff4444',
                'tachycardia': '#ffaa00',
                'bradycardia': '#ffaa00',
                'irregular': '#ff4444',
                'atrial_fib': '#ff4444'
            };
            return colors[rhythm] || '#ffffff';
        }

        // Animație ECG în timp real (adaptată pentru date reale)
        function startECGAnimation() {
            const canvas = ecgCanvas;
            const ctx = ecgCtx;
            if (!canvas || !ctx) return;
            
            const width = canvas.width / 2;
            const height = canvas.height / 2;
            const centerY = height / 2;
            
            function animate() {
                // Curăță canvas-ul
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, width, height);
                
                // Desenează grila ECG
                drawECGGrid(ctx, width, height);
                
                let hasAnomaly = false;
                
                if (isReceivingRealECG && ecgDataBuffer.length > 0) {
                    // MODUL REAL: Desenează date reale de la Arduino
                    drawRealECGData(ctx, width, height, centerY);
                    hasAnomaly = detectECGAnomalies();
                } else {
                    // MODUL SIMULAT: Generează undă matematică
                    drawSimulatedECGData(ctx, width, height, centerY);
                    hasAnomaly = isECGAnomalous();
                }
                
                ecgAnimation = requestAnimationFrame(animate);
            }
            
            animate();
        }

        // Desenează date ECG reale de la Arduino
        function drawRealECGData(ctx, width, height, centerY) {
            if (ecgDataBuffer.length < 2) return;
            
            // Detectează anomalii pentru culoare
            const hasAnomaly = detectECGAnomalies();
            ctx.strokeStyle = hasAnomaly ? '#ff4444' : '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            // Desenează ultimele puncte din buffer
            const pointsToShow = Math.min(ecgDataBuffer.length, width);
            const startIndex = Math.max(0, ecgDataBuffer.length - pointsToShow);
            
            for (let i = 0; i < pointsToShow; i++) {
                const dataIndex = startIndex + i;
                const amplitude = ecgDataBuffer[dataIndex];
                
                // Normalizează amplitudinea (presupunem valori între -2 și +2)
                const normalizedAmplitude = Math.max(-1, Math.min(1, amplitude / 2));
                
                const x = (i / pointsToShow) * width;
                const y = centerY - (normalizedAmplitude * centerY * 0.8);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
            
            // Efect de "sweep" - linie verticală care se mișcă
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1;
            ctx.beginPath();
            const sweepX = (Date.now() / 50) % width; // Se mișcă de la stânga la dreapta
            ctx.moveTo(sweepX, 0);
            ctx.lineTo(sweepX, height);
            ctx.stroke();
        }

        // Desenează date ECG simulate (pentru demo)
        function drawSimulatedECGData(ctx, width, height, centerY) {
            const currentTime = Date.now() / 1000;
            const heartRate = getCurrentHeartRate();
            const hasAnomaly = isECGAnomalous();
            
            ctx.strokeStyle = hasAnomaly ? '#ff4444' : '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const samplesPerSecond = 50;
            const secondsVisible = 6;
            const totalSamples = samplesPerSecond * secondsVisible;
            
            for (let i = 0; i < totalSamples; i++) {
                const timeOffset = (i / samplesPerSecond) - secondsVisible;
                const sampleTime = currentTime + timeOffset;
                const amplitude = generateECGWave(sampleTime, heartRate, hasAnomaly);
                
                const x = (i / totalSamples) * width;
                const y = centerY - (amplitude * centerY * 0.8);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
        }

        // Detectează anomalii în datele ECG reale
        function detectECGAnomalies() {
            if (ecgDataBuffer.length < 100) return false; // Trebuie date suficiente
            
            // Verifică ultimele 100 de puncte pentru anomalii
            const recentData = ecgDataBuffer.slice(-100);
            
            // Calculează variația standard
            const mean = recentData.reduce((a, b) => a + b, 0) / recentData.length;
            const variance = recentData.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / recentData.length;
            const stdDev = Math.sqrt(variance);
            
            // Detectează valori extreme (posibile aritmii)
            const extremeValues = recentData.filter(val => Math.abs(val - mean) > 3 * stdDev);
            
            // Dacă >5% din puncte sunt extreme, e posibilă aritmie
            return extremeValues.length > recentData.length * 0.05;
        }

        // Generare undă ECG realistă (pentru modul simulat)
        function generateECGWave(time, heartRate = 75, anomaly = false) {
            const beatInterval = 60 / heartRate;
            const beatPhase = (time % beatInterval) / beatInterval;
            
            let amplitude = 0;
            
            if (beatPhase < 0.1) {
                amplitude = 0.2 * Math.sin(beatPhase * 10 * Math.PI);
            } else if (beatPhase < 0.2) {
                amplitude = 0;
            } else if (beatPhase < 0.35) {
                const qrsPhase = (beatPhase - 0.2) / 0.15;
                if (qrsPhase < 0.3) {
                    amplitude = -0.3 * Math.sin(qrsPhase * 3.33 * Math.PI);
                } else if (qrsPhase < 0.7) {
                    amplitude = 1.5 * Math.sin((qrsPhase - 0.3) * 2.5 * Math.PI);
                } else {
                    amplitude = -0.4 * Math.sin((qrsPhase - 0.7) * 3.33 * Math.PI);
                }
            } else if (beatPhase < 0.5) {
                amplitude = 0;
            } else if (beatPhase < 0.7) {
                amplitude = 0.3 * Math.sin((beatPhase - 0.5) * 5 * Math.PI);
            } else {
                amplitude = 0;
            }
            
            if (anomaly) {
                amplitude += 0.2 * Math.sin(time * 20) * Math.random();
            }
            
            amplitude += (Math.random() - 0.5) * 0.05;
            
            return amplitude;
        }

        // Desenează grila ECG ca pe monitoarele medicale
        function drawECGGrid(ctx, width, height) {
            ctx.strokeStyle = '#004400';
            ctx.lineWidth = 0.5;
            
            // Linii verticale (timpul)
            const verticalSpacing = width / 30;
            for (let x = 0; x < width; x += verticalSpacing) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            
            // Linii orizontale (amplitudinea)
            const horizontalSpacing = height / 10;
            for (let y = 0; y < height; y += horizontalSpacing) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Linia centrală mai groasă
            ctx.strokeStyle = '#006600';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, height / 2);
            ctx.lineTo(width, height / 2);
            ctx.stroke();
        }

        // Obține frecvența cardiacă curentă
        function getCurrentHeartRate() {
            if (selectedPatientId) {
                const pulseElement = document.getElementById('pulse-value');
                const pulseText = pulseElement.textContent;
                const pulse = parseInt(pulseText.replace(' BPM', ''));
                return isNaN(pulse) ? 75 : pulse;
            }
            return 75;
        }

        // Verifică dacă ECG-ul are anomalii
        function isECGAnomalous() {
            if (selectedPatientId) {
                const statusElement = document.getElementById('ecg-status');
                return statusElement.className.includes('critical') || statusElement.className.includes('warning');
            }
            return false;
        }

        // Actualizează informațiile ECG
        function updateECGInfo(heartRate, hasAnomaly) {
            const bpmElement = document.getElementById('ecg-bpm');
            const rhythmElement = document.getElementById('ecg-rhythm');
            
            if (bpmElement) {
                bpmElement.textContent = `${heartRate} BPM`;
            }
            
            if (rhythmElement) {
                if (hasAnomaly) {
                    rhythmElement.textContent = 'Aritmie detectată';
                    rhythmElement.style.color = '#ff4444';
                } else if (heartRate < 60) {
                    rhythmElement.textContent = 'Bradicardie';
                    rhythmElement.style.color = '#ffaa00';
                } else if (heartRate > 100) {
                    rhythmElement.textContent = 'Tahicardie';
                    rhythmElement.style.color = '#ffaa00';
                } else {
                    rhythmElement.textContent = 'Ritm sinusal normal';
                    rhythmElement.style.color = '#00ff00';
                }
            }
        }

        // Încărcare lista pacienților din API
        async function loadPatients() {
            try {
                // Dacă e mod demo, folosește date simulate
                if (authToken === 'demo_token_123') {
                    const mockPatients = [
                        { 
                            id_pacient: 1, 
                            nume: 'Popescu', 
                            prenume: 'Ion', 
                            email: 'ion.popescu@email.com',
                            diagnostic: 'Infecție respiratorie',
                            camera: '101'
                        },
                        { 
                            id_pacient: 2, 
                            nume: 'Ionescu', 
                            prenume: 'Maria', 
                            email: 'maria.ionescu@email.com',
                            diagnostic: 'Recuperare post-operatorie',
                            camera: '102'
                        },
                        { 
                            id_pacient: 3, 
                            nume: 'Dumitrescu', 
                            prenume: 'Gheorghe', 
                            email: 'gheorghe.dumitrescu@email.com',
                            diagnostic: 'Fibrilație atrială',
                            camera: '103'
                        },
                        { 
                            id_pacient: 4, 
                            nume: 'Georgescu', 
                            prenume: 'Ana', 
                            email: 'ana.georgescu@email.com',
                            diagnostic: 'Hipotensiune arterială',
                            camera: '104'
                        }
                    ];
                    displayPatients(mockPatients);
                    return;
                }

                // Folosește noul endpoint specific pentru medicul curent
                console.log(`Încărcare pacienți pentru medicul ID: ${currentDoctor.id}`);
                
                const response = await fetch(`${API_BASE_URL}/medic/${currentDoctor.id}/pacienti`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                console.log('Response pacienti medic:', response.status);

                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const patients = await response.json();
                        console.log('Pacienți primiti din API pentru medic:', patients);
                        
                        // Adaptează structura pacienților (compatibil cu tabelele SQL)
                        const adaptedPatients = patients.map(patient => ({
                            id_pacient: patient.id_pacient || patient.id,
                            nume: patient.nume || 'Necunoscut',
                            prenume: patient.prenume || 'Pacient',
                            email: patient.email || 'N/A',
                            // Generează camera și diagnostic dacă lipsesc din tabela SQL
                            camera: patient.camera || `Camera ${(patient.id_pacient || 100) + 100}`,
                            diagnostic: patient.diagnostic || 'Monitorizare generală',
                            // Adaugă informații suplimentare dacă sunt disponibile
                            data_nasterii: patient.data_nasterii,
                            telefon: patient.telefon
                        }));
                        
                        displayPatients(adaptedPatients);
                        showMessage(`${adaptedPatients.length} pacienți încărcați din API real`, 'success');
                    } else {
                        throw new Error('API /medic/pacienti returnează HTML în loc de JSON');
                    }
                } else if (response.status === 404) {
                    // Dacă nu există endpoint specific pentru medic, încearcă endpoint-ul general
                    console.log('Endpoint /medic/:id/pacienti nu există, încerc /pacienti...');
                    await loadPatientsGeneral();
                } else {
                    throw new Error(`API /medic/pacienti răspunde cu status ${response.status}`);
                }
            } catch (error) {
                console.error('Eroare la încărcarea pacienților din API:', error);
                
                // Fallback la endpoint general
                try {
                    await loadPatientsGeneral();
                } catch (fallbackError) {
                    console.error('Fallback la endpoint general eșuat:', fallbackError);
                    
                    // Ultimul fallback - date simulate
                    const mockPatients = [
                        { id_pacient: 1, nume: 'Popescu', prenume: 'Ion', email: 'ion.popescu@email.com', diagnostic: 'Simulat - Infecție respiratorie', camera: '101' },
                        { id_pacient: 2, nume: 'Ionescu', prenume: 'Maria', email: 'maria.ionescu@email.com', diagnostic: 'Simulat - Post-operator', camera: '102' },
                        { id_pacient: 3, nume: 'Dumitrescu', prenume: 'Gheorghe', email: 'gheorghe.dumitrescu@email.com', diagnostic: 'Simulat - Aritmie cardiacă', camera: '103' },
                        { id_pacient: 4, nume: 'Georgescu', prenume: 'Ana', email: 'ana.georgescu@email.com', diagnostic: 'Simulat - Hipotensiune', camera: '104' }
                    ];
                    displayPatients(mockPatients);
                    showMessage('Folosind date simulate - verifică endpoint-urile API', 'info');
                }
            }
        }

        // Încărcare pacienți din endpoint general (fallback)
        async function loadPatientsGeneral() {
            const response = await fetch(`${API_BASE_URL}/pacienti`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                }
            });

            if (response.ok) {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const patients = await response.json();
                    console.log('Pacienți din endpoint general:', patients);
                    
                    const adaptedPatients = patients.map(patient => ({
                        id_pacient: patient.id_pacient || patient.id,
                        nume: patient.nume || 'Necunoscut',
                        prenume: patient.prenume || 'Pacient',
                        email: patient.email || 'N/A',
                        // Generează camera și diagnostic dacă lipsesc din tabela SQL
                        camera: patient.camera || `Camera ${(patient.id_pacient || 100) + 100}`,
                        diagnostic: patient.diagnostic || 'Monitorizare generală',
                        // Adaugă informații suplimentare dacă sunt disponibile
                        data_nasterii: patient.data_nasterii,
                        telefon: patient.telefon
                    }));
                    
                    displayPatients(adaptedPatients);
                    showMessage(`${adaptedPatients.length} pacienți încărcați din endpoint general`, 'success');
                } else {
                    throw new Error('Endpoint general returnează HTML');
                }
            } else {
                throw new Error(`Endpoint general răspunde cu ${response.status}`);
            }
        }

        // Afișare lista pacienților în interfață
        function displayPatients(patients) {
            const container = document.getElementById('patients-container');
            
            if (!patients || patients.length === 0) {
                container.innerHTML = `
                    <div class="info">
                        📋 Nu sunt pacienți înregistrați în sistem.
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            patients.forEach(patient => {
                const patientElement = document.createElement('div');
                patientElement.className = 'patient-item';
                patientElement.onclick = () => selectPatient(
                    patient.id_pacient || patient.id, 
                    `${patient.prenume || patient.nume} ${patient.nume || patient.prenume}`
                );
                
                patientElement.innerHTML = `
                    <div class="patient-info">
                        <div class="patient-name">${patient.prenume || patient.nume} ${patient.nume || patient.prenume}</div>
                        <div class="patient-details">
                            📧 ${patient.email || 'N/A'} | 
                            🏥 Camera ${patient.camera || 'N/A'} | 
                            📋 ${patient.diagnostic || 'Monitorizare generală'}
                        </div>
                    </div>
                    <div class="patient-status">
                        <div class="alert-indicator alert-offline" id="alert-${patient.id_pacient || patient.id}"></div>
                    </div>
                `;
                
                container.appendChild(patientElement);
            });
        }

        // Selectare pacient (îmbunătățită)
        function selectPatient(patientId, patientName) {
            console.log(`Selectare pacient: ${patientId} - ${patientName}`);
            
            // Elimină selecția anterioară
            document.querySelectorAll('.patient-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Selectează pacientul curent
            event.target.closest('.patient-item').classList.add('selected');
            
            selectedPatientId = patientId;
            document.getElementById('selected-patient-name').textContent = patientName;
            document.getElementById('patient-values').classList.add('active');
            
            // Actualizează imediat măsurătorile pentru pacientul selectat
            setTimeout(async () => {
                const measurements = await getPatientMeasurements(patientId);
                updateSelectedPatientValues(measurements);
                
                // Reinițializează ECG pentru noul pacient
                if (ecgAnimation) {
                    cancelAnimationFrame(ecgAnimation);
                }
                initializeECG();
            }, 100);
        }

        // Deconectare
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentDoctor');
            authToken = null;
            currentDoctor = {};
            selectedPatientId = null;
            
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('patient-values').classList.remove('active');
            showMessage('Ați fost deconectat din portal.', 'success');
        }

        // Obținere măsurători folosind API-ul colegului
        async function getPatientMeasurements(patientId) {
            console.log(`Obținere măsurători pentru pacientul ${patientId}`);
            
            try {
                // În mod demo, returnează întotdeauna date simulate
                if (authToken === 'demo_token_123') {
                    const measurements = generateSimulatedData(patientId);
                    console.log(`Date simulate generate pentru ${patientId}:`, measurements);
                    return measurements;
                }
                
                // Folosește funcția API exactă a colegului
                try {
                    const measurements = await getMasuratori(patientId);
                    console.log(`Măsurători din API-ul colegului pentru pacientul ${patientId}:`, measurements);
                    
                    // Adaptează formatul dacă e necesar
                    return {
                        temperatura: measurements.temperatura || measurements.temperature || '36.5',
                        puls: measurements.puls || measurements.heartRate || measurements.pulse || '75',
                        umiditate: measurements.umiditate || measurements.humidity || '50',
                        ecg: measurements.ecg || measurements.ecgValue || '0.6',
                        timestamp: measurements.timestamp || new Date().toLocaleString('ro-RO'),
                        ecgRealTime: measurements.ecgRealTime || {
                            rawData: generateECGPoints(),
                            heartRate: parseInt(measurements.puls || measurements.pulse || 75),
                            rhythm: measurements.rhythm || 'normal'
                        }
                    };
                } catch (apiError) {
                    console.log('API măsurători nu funcționează, folosesc date simulate');
                    throw apiError;
                }
            } catch (error) {
                console.error('Eroare măsurători:', error);
                
                // Fallback la date simulate
                const measurements = generateSimulatedData(patientId);
                console.log(`Fallback la date simulate pentru ${patientId}:`, measurements);
                return measurements;
            }
        }

        // Pornește monitorizarea automată
        function startMonitoring() {
            console.log('Pornire monitorizare...');
            
            // Oprește intervalul anterior dacă există
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            // Prima actualizare imediată
            updatePatientsStatus();
            
            // Actualizare la fiecare 3 secunde (mai rapid pentru demo)
            updateInterval = setInterval(() => {
                console.log('Actualizare automată...');
                updatePatientsStatus();
            }, 3000);
        }

        // Generare puncte ECG pentru streaming simulat
        function generateECGPoints() {
            const points = [];
            for (let i = 0; i < 10; i++) {
                points.push((Math.random() - 0.5) * 1.5);
            }
            return points;
        }

        // Obținere alerte pentru un pacient
        async function getPatientAlerts(patientId) {
            try {
                const response = await fetch(`${API_BASE_URL}/pacient/${patientId}/alerte`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                if (response.ok) {
                    const alerts = await response.json();
                    console.log(`Alerte pentru pacientul ${patientId}:`, alerts);
                    return alerts;
                } else {
                    throw new Error(`Endpoint alerte răspunde cu ${response.status}`);
                }
            } catch (error) {
                console.error('Eroare alerte:', error);
                return []; // Returnează array gol dacă nu sunt alerte
            }
        }

        // Obținere recomandări pentru un pacient
        async function getPatientRecommendations(patientId) {
            try {
                const response = await fetch(`${API_BASE_URL}/pacient/${patientId}/recomandari`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                if (response.ok) {
                    const recommendations = await response.json();
                    console.log(`Recomandări pentru pacientul ${patientId}:`, recommendations);
                    return recommendations;
                } else {
                    throw new Error(`Endpoint recomandări răspunde cu ${response.status}`);
                }
            } catch (error) {
                console.error('Eroare recomandări:', error);
                return []; // Returnează array gol dacă nu sunt recomandări
            }
        }

        // Trimitere recomandare nouă pentru un pacient (adaptat la API-ul colegului)
        async function sendPatientRecommendation(patientId, recommendationText) {
            try {
                const response = await fetch(`${API_BASE_URL}/pacient/${patientId}/recomandari`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        text: recommendationText  // Format adaptat la API-ul colegului
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Recomandare trimisă cu succes:', result);
                    showMessage('Recomandare salvată cu succes!', 'success');
                    return result;
                } else {
                    throw new Error(`Trimitere recomandare eșuată: ${response.status}`);
                }
            } catch (error) {
                console.error('Eroare trimitere recomandare:', error);
                showMessage('Eroare la salvarea recomandării', 'error');
                return null;
            }
        }

        // Obținere statistici pentru medic
        async function getDoctorStatistics() {
            try {
                const response = await fetch(`${API_BASE_URL}/medic/${currentDoctor.id}/statistici`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    console.log('Statistici medic:', stats);
                    return stats;
                } else {
                    throw new Error(`Endpoint statistici răspunde cu ${response.status}`);
                }
            } catch (error) {
                console.error('Eroare statistici:', error);
                return {
                    totalPacienti: 0,
                    alerteActive: 0,
                    recomandariTrimise: 0
                };
            }
        }

        // Generare date simulate pentru demonstrație (cu puncte ECG reale)
        function generateSimulatedData(patientId) {
            const patientProfiles = {
                1: { // Ion Popescu - Pacient cu febră și tahicardie
                    name: "Ion Popescu",
                    condition: "Infecție respiratorie",
                    temp: { base: 38.2, variation: 0.4 },
                    puls: { base: 105, variation: 15 },
                    umiditate: { base: 45, variation: 5 },
                    ecg: { base: 0.7, variation: 0.2, anomaly: false }
                },
                2: { // Maria Ionescu - Pacient stabil, post-operator
                    name: "Maria Ionescu", 
                    condition: "Recuperare post-operatorie",
                    temp: { base: 36.4, variation: 0.2 },
                    puls: { base: 72, variation: 8 },
                    umiditate: { base: 50, variation: 3 },
                    ecg: { base: 0.5, variation: 0.1, anomaly: false }
                },
                3: { // Gheorghe Dumitrescu - Pacient cu aritmie cardiacă
                    name: "Gheorghe Dumitrescu",
                    condition: "Fibrilație atrială",
                    temp: { base: 36.8, variation: 0.3 },
                    puls: { base: 95, variation: 25 }, // Puls irregular
                    umiditate: { base: 48, variation: 4 },
                    ecg: { base: 0.9, variation: 0.4, anomaly: true } // Aritmie
                },
                4: { // Ana Georgescu - Pacient cu hipotensiune și bradicardie
                    name: "Ana Georgescu",
                    condition: "Hipotensiune arterială", 
                    temp: { base: 36.1, variation: 0.2 },
                    puls: { base: 55, variation: 8 }, // Bradicardie
                    umiditate: { base: 52, variation: 3 },
                    ecg: { base: 0.4, variation: 0.1, anomaly: false }
                }
            };

            const profile = patientProfiles[patientId] || patientProfiles[2]; // Default la pacient stabil
            
            // Generare valori cu variații realiste
            const temp = profile.temp.base + (Math.random() - 0.5) * profile.temp.variation;
            const puls = Math.round(profile.puls.base + (Math.random() - 0.5) * profile.puls.variation);
            const umiditate = profile.umiditate.base + (Math.random() - 0.5) * profile.umiditate.variation;
            const ecg = Math.max(0.1, profile.ecg.base + (Math.random() - 0.5) * profile.ecg.variation);
            
            // Simulare deteriorare/îmbunătățire în timp
            const timeVariation = Math.sin(Date.now() / 30000) * 0.1; // Ciclu de 1 minut
            
            // Generare puncte ECG simulate (pentru demonstrația streaming-ului)
            const ecgPoints = [];
            for (let i = 0; i < 10; i++) { // 10 puncte noi la fiecare update
                const point = ecg + (Math.random() - 0.5) * 0.3;
                ecgPoints.push(point);
            }
            
            const result = {
                temperatura: Math.max(35.0, Math.min(42.0, temp + timeVariation)).toFixed(1),
                puls: Math.max(30, Math.min(200, Math.round(puls + timeVariation * 5))),
                umiditate: Math.max(20, Math.min(80, umiditate + timeVariation * 2)).toFixed(1),
                ecg: Math.max(0.1, Math.min(2.0, ecg + timeVariation * 0.1)).toFixed(2),
                timestamp: new Date().toLocaleString('ro-RO'),
                patientInfo: {
                    name: profile.name,
                    condition: profile.condition,
                    hasAnomaly: profile.ecg.anomaly
                },
                // NOUA FUNCȚIONALITATE: Puncte ECG pentru streaming
                ecgRealTime: {
                    rawData: ecgPoints, // Array cu puncte ECG
                    heartRate: Math.round(puls + timeVariation * 5),
                    rhythm: profile.ecg.anomaly ? 'arrhythmia' : 'normal',
                    sampleRate: 100 // Hz
                }
            };
            
            // Simulează primirea datelor ECG în timp real
            if (selectedPatientId == patientId) {
                processRealTimeECG(result.ecgRealTime);
            }
            
            return result;
        }

        // Actualizare statusuri pacienți
        async function updatePatientsStatus() {
            if (!isApiConnected) return;
            
            try {
                const patientElements = document.querySelectorAll('.patient-item');
                
                for (let element of patientElements) {
                    const alertElement = element.querySelector('.alert-indicator');
                    const patientId = alertElement.id.replace('alert-', '');
                    
                    const measurements = await getPatientMeasurements(patientId);
                    updatePatientAlert(patientId, measurements);
                    
                    // Dacă este pacientul selectat, actualizează valorile
                    if (selectedPatientId == patientId) {
                        updateSelectedPatientValues(measurements);
                    }
                }
                
                document.getElementById('last-update').textContent = new Date().toLocaleString('ro-RO');
            } catch (error) {
                console.error('Eroare la actualizarea statusului:', error);
            }
        }

        // Actualizare bulinuță alertă pentru un pacient
        function updatePatientAlert(patientId, measurements) {
            const alertElement = document.getElementById(`alert-${patientId}`);
            if (!alertElement) return;

            const temp = parseFloat(measurements.temperatura);
            const puls = parseInt(measurements.puls);
            const ecg = parseFloat(measurements.ecg);

            // Logica pentru determinarea tipului de alertă
            let alertType = 'normal';
            
            // Valori critice
            if (temp > 38.5 || temp < 35.5 || puls > 120 || puls < 50 || ecg > 1.0) {
                alertType = 'critical';
            }
            // Valori de atenționare
            else if (temp > 37.5 || temp < 36.0 || puls > 100 || puls < 60 || ecg > 0.8) {
                alertType = 'warning';
            }

            // Actualizează clasa bulinuței
            alertElement.className = `alert-indicator alert-${alertType}`;
        }

        // Actualizare valori pentru pacientul selectat
        function updateSelectedPatientValues(measurements) {
            document.getElementById('temp-value').textContent = `${measurements.temperatura}°C`;
            document.getElementById('pulse-value').textContent = `${measurements.puls} BPM`;
            document.getElementById('humidity-value').textContent = `${measurements.umiditate}%`;

            // Actualizează statusurile
            const temp = parseFloat(measurements.temperatura);
            const puls = parseInt(measurements.puls);
            const ecgValue = parseFloat(measurements.ecg);

            updateValueStatus('temp', temp, [36.0, 37.5], [35.5, 38.5]);
            updateValueStatus('pulse', puls, [60, 100], [50, 120]);
            updateValueStatus('ecg', ecgValue, [0.3, 0.8], [0.2, 1.0]);
            
            // Umiditatea este mai mult informativă
            document.getElementById('humidity-status').textContent = 'Monitorizare';
            document.getElementById('humidity-status').className = 'value-status status-normal';
            
            // ECG-ul se actualizează automat prin animație
            // Nu mai setăm valoarea manual pentru că avem graficul
        }

        // Actualizare status pentru o valoare specifică
        function updateValueStatus(prefix, value, normalRange, criticalRange) {
            const statusElement = document.getElementById(`${prefix}-status`);
            
            if (value < criticalRange[0] || value > criticalRange[1]) {
                statusElement.textContent = 'CRITIC';
                statusElement.className = 'value-status status-critical';
            } else if (value < normalRange[0] || value > normalRange[1]) {
                statusElement.textContent = 'Atenție';
                statusElement.className = 'value-status status-warning';
            } else {
                statusElement.textContent = 'Normal';
                statusElement.className = 'value-status status-normal';
            }
        }

        // Mod demonstrație - sare peste login
        function demoMode() {
            // Simulează un doctor logat
            currentDoctor = {
                id: 1,
                nume: 'Dr. Demo',
                email: 'demo@spital.ro'
            };
            
            authToken = 'demo_token_123';
            
            localStorage.setItem('authToken', authToken);
            localStorage.setItem('currentDoctor', JSON.stringify(currentDoctor));
            
            showMessage('Mod demonstrație activat! Toate datele sunt simulate.', 'success');
            showDashboard();
            
            // Forțează pornirea monitorizării după o secundă
            setTimeout(() => {
                console.log('Pornire monitorizare forțată...');
                startMonitoring();
            }, 1000);
        }

        // Configurare globală
        let API_BASE_URL = BASE_URL;
        let authToken = localStorage.getItem('authToken');
        let currentDoctor = JSON.parse(localStorage.getItem('currentDoctor') || '{}');
        let selectedPatientId = null;
        let updateInterval = null;
        let isApiConnected = false;

        // Actualizare statusuri pacienți (îmbunătățită)
        async function updatePatientsStatus() {
            console.log('Actualizare statusuri pacienți...');
            
            try {
                const patientElements = document.querySelectorAll('.patient-item');
                console.log(`Găsite ${patientElements.length} elemente pacienți`);
                
                for (let element of patientElements) {
                    const alertElement = element.querySelector('.alert-indicator');
                    if (!alertElement) {
                        console.log('Nu s-a găsit elementul de alertă');
                        continue;
                    }
                    
                    const patientId = alertElement.id.replace('alert-', '');
                    console.log(`Actualizare pacient ID: ${patientId}`);
                    
                    const measurements = await getPatientMeasurements(patientId);
                    console.log(`Măsurători pacient ${patientId}:`, measurements);
                    
                    updatePatientAlert(patientId, measurements);
                    
                    // Dacă este pacientul selectat, actualizează valorile
                    if (selectedPatientId == patientId) {
                        console.log(`Actualizare valori pentru pacientul selectat: ${patientId}`);
                        updateSelectedPatientValues(measurements);
                    }
                }
                
                document.getElementById('last-update').textContent = new Date().toLocaleString('ro-RO');
                console.log('Actualizare completă');
            } catch (error) {
                console.error('Eroare la actualizarea statusului:', error);
            }
        }
    </script>
</body>
</html>
